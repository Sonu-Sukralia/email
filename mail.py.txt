"""
Outlook Email Notifier - Standalone Script
Monitors Outlook inbox and shared mailboxes and shows desktop notifications
"""

import win32com.client
import time
from datetime import datetime, timedelta
import winsound
import sys

class OutlookMonitor:
    def __init__(self):
        self.outlook = None
        self.namespace = None
        self.last_check_time = {}
        
        # Configuration
        self.check_interval = 15  # seconds
        self.primary_email = "sonu@cap.com"
        self.shared_mailboxes = [
            '4Data',
            'EDO LASR'
        ]
        self.play_sound = True
        
    def connect_outlook(self):
        """Connect to Outlook application"""
        try:
            self.outlook = win32com.client.Dispatch("Outlook.Application")
            self.namespace = self.outlook.GetNamespace("MAPI")
            print("âœ… Connected to Outlook successfully")
            return True
        except Exception as e:
            print(f"âŒ Error connecting to Outlook: {e}")
            print("Make sure Outlook is running!")
            return False
    
    def show_notification(self, subject, sender, mailbox=None):
        """Show Windows notification"""
        try:
            from win10toast import ToastNotifier
            toaster = ToastNotifier()
            
            if mailbox:
                mailbox_label = f" [{mailbox}]"
            else:
                mailbox_label = f" [{self.primary_email}]"
            
            title = f"ğŸ“§ New Email{mailbox_label}"
            message = f"From: {sender}\nSubject: {subject}"
            
            toaster.show_toast(
                title,
                message,
                duration=5,
                threaded=True
            )
        except ImportError:
            if mailbox:
                mailbox_label = f" [{mailbox}]"
            else:
                mailbox_label = f" [{self.primary_email}]"
            
            print(f"\n{'='*60}")
            print(f"ğŸ“§ NEW EMAIL{mailbox_label}")
            print(f"From: {sender}")
            print(f"Subject: {subject}")
            print(f"Time: {datetime.now().strftime('%H:%M:%S')}")
            print(f"{'='*60}\n")
    
    def play_notification_sound(self):
        """Play notification sound"""
        if self.play_sound:
            try:
                winsound.PlaySound("SystemAsterisk", winsound.SND_ALIAS)
            except:
                print("ğŸ”” *ding*")
    
    def check_inbox(self, folder_name=None):
        """Check inbox for new emails"""
        try:
            if folder_name:
                # Check shared mailbox - Try multiple methods
                inbox = None
                
                try:
                    inbox = self.namespace.Folders(folder_name).Folders("Inbox")
                    print(f"ğŸ” Checking {folder_name}...")
                except Exception as e1:
                    try:
                        inbox = self.namespace.Folders.Item(folder_name).Folders("Inbox")
                        print(f"ğŸ” Checking {folder_name}...")
                    except Exception as e2:
                        print(f"   ğŸ” Searching for folder '{folder_name}'...")
                        for folder in self.namespace.Folders:
                            if folder.Name.lower() == folder_name.lower():
                                inbox = folder.Folders("Inbox")
                                print(f"   âœ… Found folder: {folder.Name}")
                                break
                
                if not inbox:
                    print(f"âŒ Could not access mailbox: {folder_name}")
                    return
                    
                mailbox_key = folder_name
            else:
                inbox = self.namespace.GetDefaultFolder(6)
                mailbox_key = "primary"
                print(f"ğŸ” Checking {self.primary_email}...")
            
            now = datetime.now()
            
            if mailbox_key not in self.last_check_time:
                self.last_check_time[mailbox_key] = now
                display_name = folder_name if folder_name else f"{self.primary_email} (Primary Inbox)"
                print(f"ğŸ“¬ Monitoring: {display_name}")
                print(f"â° Starting monitoring from: {now.strftime('%H:%M:%S')}")
                return
            
            # OPTIMIZED: Filter messages by received time BEFORE iterating
            messages = inbox.Items
            messages.Sort("[ReceivedTime]", True)
            
            # Use Restrict to filter only recent unread messages
            filter_time = self.last_check_time[mailbox_key].strftime('%m/%d/%Y %H:%M %p')
            filter_str = f"[UnRead] = True AND [ReceivedTime] > '{filter_time}'"
            
            try:
                filtered_messages = messages.Restrict(filter_str)
                new_count = filtered_messages.Count
                
                if new_count > 0:
                    print(f"   âœ… Found {new_count} new email(s)!")
                    
                    # Only process up to 10 most recent to avoid spam
                    count = 0
                    for message in filtered_messages:
                        if count >= 10:
                            print(f"   âš ï¸  More than 10 new emails, showing first 10 only")
                            break
                        try:
                            self.show_notification(
                                message.Subject,
                                message.SenderName,
                                folder_name
                            )
                            count += 1
                            time.sleep(0.5)  # Small delay between notifications
                        except:
                            continue
                    
                    self.play_notification_sound()
                else:
                    print(f"   â„¹ï¸  No new emails")
                    
            except Exception as filter_error:
                # Fallback to manual checking if Restrict fails
                print(f"   âš ï¸  Using fallback method...")
                new_count = 0
                for message in messages:
                    if new_count >= 10:  # Limit to first 10
                        break
                    try:
                        if message.UnRead:
                            received_time = message.ReceivedTime
                            
                            if not isinstance(received_time, datetime):
                                try:
                                    received_time = datetime.strptime(str(received_time), '%Y-%m-%d %H:%M:%S')
                                except:
                                    continue
                            
                            if received_time > self.last_check_time[mailbox_key]:
                                self.show_notification(
                                    message.Subject,
                                    message.SenderName,
                                    folder_name
                                )
                                new_count += 1
                                time.sleep(0.5)
                    except:
                        continue
                
                if new_count > 0:
                    self.play_notification_sound()
                else:
                    print(f"   â„¹ï¸  No new emails")
            
            self.last_check_time[mailbox_key] = now
            print("")
            
        except Exception as e:
            print(f"âŒ Error: {e}")
            import traceback
            traceback.print_exc()
    
    def monitor(self):
        """Main monitoring loop"""
        if not self.connect_outlook():
            return
        
        print(f"\nğŸš€ Starting email monitor...")
        print(f"â±ï¸  Check interval: {self.check_interval} seconds")
        print(f"ğŸ“§ Monitoring: {self.primary_email} (Primary Inbox)")
        for mailbox in self.shared_mailboxes:
            print(f"ğŸ“§ Monitoring: {mailbox} (Shared Mailbox)")
        print("\nâŒ¨ï¸  Press Ctrl+C to stop\n")
        
        try:
            while True:
                self.check_inbox()
                
                for mailbox in self.shared_mailboxes:
                    self.check_inbox(mailbox)
                
                time.sleep(self.check_interval)
                
        except KeyboardInterrupt:
            print("\n\nâ¹ï¸  Monitor stopped")
        except Exception as e:
            print(f"\nâŒ Error: {e}")

def main():
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         OUTLOOK EMAIL NOTIFIER                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)
    
    monitor = OutlookMonitor()
    monitor.monitor()

if __name__ == "__main__":
    main()






































"""
Outlook Email Notifier - Standalone Script
Monitors Outlook inbox and shared mailboxes and shows desktop notifications
"""

import win32com.client
import time
from datetime import datetime, timedelta
import winsound
import sys

class OutlookMonitor:
    def __init__(self):
        self.outlook = None
        self.namespace = None
        self.last_check_time = {}
        
        # Configuration
        self.check_interval = 15  # seconds
        self.primary_email = "sonu@cap.com"
        self.shared_mailboxes = [
            '4Data',
            'EDO LASR'
        ]
        self.play_sound = True
        
    def connect_outlook(self):
        """Connect to Outlook application"""
        try:
            self.outlook = win32com.client.Dispatch("Outlook.Application")
            self.namespace = self.outlook.GetNamespace("MAPI")
            print("âœ… Connected to Outlook successfully")
            return True
        except Exception as e:
            print(f"âŒ Error connecting to Outlook: {e}")
            print("Make sure Outlook is running!")
            return False
    
    def show_notification(self, subject, sender, mailbox=None):
        """Show Windows notification"""
        try:
            from plyer import notification
            
            if mailbox:
                mailbox_label = f" [{mailbox}]"
            else:
                mailbox_label = f" [{self.primary_email}]"
            
            title = f"New Email{mailbox_label}"
            message = f"From: {sender}\nSubject: {subject}"
            
            notification.notify(
                title=title,
                message=message,
                app_name='Outlook Notifier',
                timeout=5
            )
            
        except Exception as e:
            # Fallback to console if notification fails
            if mailbox:
                mailbox_label = f" [{mailbox}]"
            else:
                mailbox_label = f" [{self.primary_email}]"
            
            print(f"\n{'='*60}")
            print(f"ğŸ“§ NEW EMAIL{mailbox_label}")
            print(f"From: {sender}")
            print(f"Subject: {subject}")
            print(f"Time: {datetime.now().strftime('%H:%M:%S')}")
            print(f"{'='*60}\n")
    
    def play_notification_sound(self):
        """Play notification sound"""
        if self.play_sound:
            try:
                winsound.PlaySound("SystemAsterisk", winsound.SND_ALIAS)
            except:
                print("ğŸ”” *ding*")
    
    def check_inbox(self, folder_name=None):
        """Check inbox for new emails"""
        try:
            if folder_name:
                # Check shared mailbox - Try multiple methods
                inbox = None
                
                try:
                    inbox = self.namespace.Folders(folder_name).Folders("Inbox")
                    print(f"ğŸ” Checking {folder_name}...")
                except Exception as e1:
                    try:
                        inbox = self.namespace.Folders.Item(folder_name).Folders("Inbox")
                        print(f"ğŸ” Checking {folder_name}...")
                    except Exception as e2:
                        print(f"   ğŸ” Searching for folder '{folder_name}'...")
                        for folder in self.namespace.Folders:
                            if folder.Name.lower() == folder_name.lower():
                                inbox = folder.Folders("Inbox")
                                print(f"   âœ… Found folder: {folder.Name}")
                                break
                
                if not inbox:
                    print(f"âŒ Could not access mailbox: {folder_name}")
                    return
                    
                mailbox_key = folder_name
            else:
                inbox = self.namespace.GetDefaultFolder(6)
                mailbox_key = "primary"
                print(f"ğŸ” Checking {self.primary_email}...")
            
            now = datetime.now()
            
            if mailbox_key not in self.last_check_time:
                self.last_check_time[mailbox_key] = now
                display_name = folder_name if folder_name else f"{self.primary_email} (Primary Inbox)"
                print(f"ğŸ“¬ Monitoring: {display_name}")
                print(f"â° Starting monitoring from: {now.strftime('%H:%M:%S')}")
                return
            
            # OPTIMIZED: Filter messages by received time BEFORE iterating
            messages = inbox.Items
            messages.Sort("[ReceivedTime]", True)
            
            # Use Restrict to filter only recent unread messages
            filter_time = self.last_check_time[mailbox_key].strftime('%m/%d/%Y %H:%M %p')
            filter_str = f"[UnRead] = True AND [ReceivedTime] > '{filter_time}'"
            
            try:
                filtered_messages = messages.Restrict(filter_str)
                new_count = filtered_messages.Count
                
                if new_count > 0:
                    print(f"   âœ… Found {new_count} new email(s)!")
                    
                    # Only process up to 10 most recent to avoid spam
                    count = 0
                    for message in filtered_messages:
                        if count >= 10:
                            print(f"   âš ï¸  More than 10 new emails, showing first 10 only")
                            break
                        try:
                            self.show_notification(
                                message.Subject,
                                message.SenderName,
                                folder_name
                            )
                            count += 1
                            time.sleep(1)  # 1 second delay between notifications
                        except:
                            continue
                    
                    self.play_notification_sound()
                else:
                    print(f"   â„¹ï¸  No new emails")
                    
            except Exception as filter_error:
                # Fallback to manual checking if Restrict fails
                print(f"   âš ï¸  Using fallback method...")
                new_count = 0
                for message in messages:
                    if new_count >= 10:  # Limit to first 10
                        break
                    try:
                        if message.UnRead:
                            received_time = message.ReceivedTime
                            
                            if not isinstance(received_time, datetime):
                                try:
                                    received_time = datetime.strptime(str(received_time), '%Y-%m-%d %H:%M:%S')
                                except:
                                    continue
                            
                            if received_time > self.last_check_time[mailbox_key]:
                                self.show_notification(
                                    message.Subject,
                                    message.SenderName,
                                    folder_name
                                )
                                new_count += 1
                                time.sleep(1)
                    except:
                        continue
                
                if new_count > 0:
                    self.play_notification_sound()
                else:
                    print(f"   â„¹ï¸  No new emails")
            
            self.last_check_time[mailbox_key] = now
            print("")
            
        except Exception as e:
            print(f"âŒ Error: {e}")
            import traceback
            traceback.print_exc()
    
    def monitor(self):
        """Main monitoring loop"""
        if not self.connect_outlook():
            return
        
        print(f"\nğŸš€ Starting email monitor...")
        print(f"â±ï¸  Check interval: {self.check_interval} seconds")
        print(f"ğŸ“§ Monitoring: {self.primary_email} (Primary Inbox)")
        for mailbox in self.shared_mailboxes:
            print(f"ğŸ“§ Monitoring: {mailbox} (Shared Mailbox)")
        print("\nâŒ¨ï¸  Press Ctrl+C to stop\n")
        
        try:
            while True:
                self.check_inbox()
                
                for mailbox in self.shared_mailboxes:
                    self.check_inbox(mailbox)
                
                time.sleep(self.check_interval)
                
        except KeyboardInterrupt:
            print("\n\nâ¹ï¸  Monitor stopped")
        except Exception as e:
            print(f"\nâŒ Error: {e}")

def main():
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         OUTLOOK EMAIL NOTIFIER                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)
    
    monitor = OutlookMonitor()
    monitor.monitor()

if __name__ == "__main__":
    main()
